# React Native + Expo プロジェクト開発の教訓 (フェーズ1-2)

## 環境設定と依存関係

1. **Expo Go での制約を理解する**
    - 一部のネイティブモジュール（例: react-native-mmkv）はExpo Goでは直接使用できない
    - 開発初期段階ではAsyncStorageなどの標準ライブラリを使用する
    - Development Buildに移行する時点でネイティブモジュールを追加する計画を立てる
2. **環境変数の設定**
    - `.env`ファイルと`app.config.js`の連携が重要
    - `dotenv`を使って環境変数を読み込む設定を確認する
    - `Constants.expoConfig?.extra`から値を取得する方法を覚えておく
3. **パッケージの互換性**
    - Expoのバージョンと各パッケージのバージョン互換性を確認する
    - readme.mdにある「依存関係の管理」を特に注意して実践する

## 認証とデータ永続化

1. **Supabase認証の設定**
    - セッション管理のカスタムストレージを適切に設定する
    - SecureStoreとAsyncStorageのフォールバック機構を実装する
    - `getSession`と`getCurrentUser`の失敗時のエラーハンドリングを適切に行う
2. **エラーハンドリング**
    - 認証関連のエラーは通常のログレベルで処理（未認証状態は正常）
    - 実際のエラーのみをERRORレベルで出力する
    - try-catchブロックを適切に使用し、デバッグ情報を提供する
3. **データ永続化**
    - ストレージの選択はアプリの段階に合わせる（初期はAsyncStorage、後にMMKV）
    - 重要データはSecureStoreを使用、なければフォールバックする
    - 永続化データの整合性を保つためにトランザクション的な処理を心がける

## Expo & React Native特有の注意点

1. **ディープリンクの設定**
    - `app.json`の`scheme`設定は重要（未設定だとリンク機能でクラッシュの可能性）
    - OAuthフローではリダイレクトURIが正しく設定されていることを確認する
    - WebBrowserモジュールの使用時の挙動を理解する
2. **型の定義と活用**
    - TypeScriptの型定義を活用して開発を効率化する
    - Supabaseの型はデータベーススキーマに合わせて更新する
    - ナビゲーションパラメータも適切に型定義する
3. **オフライン対応**
    - オフライン状態の検知と対応（NetInfoの活用）
    - オフラインキューの実装（ミューテーションを保存して後で実行）
    - React Queryの設定でオフライン時のデータ保持を確保

## Supabase特有の教訓

1. **RLSポリシー設定**
    - 各テーブルに適切なRow Level Securityポリシーを設定する
    - 公開/非公開設定や論理削除の取り扱いに注意する
    - ユーザー固有のデータアクセス制御を徹底する
2. **論理削除の実装**
    - `deleted_at`フィールドを使った論理削除の設計
    - 削除されたデータの処理（復旧機能など）の設計
    - クエリには常に`is('deleted_at', null)`条件を含める
3. **自動トリガーの活用**
    - 新規ユーザー作成時のプロファイル自動生成
    - 論理削除時の関連データの処理
    - PostgreSQLの関数とトリガーを活用する

## モバイルUX向上のために

1. **ローディング状態の適切な表示**
    - 認証状態確認中のローディングインジケータ
    - 操作中のフィードバック提供
    - エラー時のユーザーフレンドリーなメッセージ
2. **エラーメッセージの最適化**
    - 開発用と本番用でログレベルを調整
    - ユーザーに表示するエラーメッセージを適切に設計
    - 具体的な解決策を提示するガイダンス
3. **段階的な機能実装**
    - コア機能から開始し、徐々に追加機能を実装する
    - 各段階でしっかりテストし、安定性を確保する
    - フェーズごとの明確な目標と達成基準を設定する